<% @params[:listen_on].each do |listen| %>
<VirtualHost <%= listen[:address] %>:<%= listen[:port] %>>
  ServerName <%= @params[:name] %>
<% if @params[:server_aliases] %>
  ServerAlias <%= @params[:server_aliases].sort.join(' ') %>
<% end %>
  DocumentRoot <%= @params[:docroot] %>

  ErrorLog /var/log/apache2/<%= @params[:name] %>.error.log
  CustomLog /var/log/apache2/<%= @params[:name] %>.access.log combined

<% unless @params[:aliases].nil? || @params[:aliases].empty? %>
<%= @params[:aliases].map { |url_path,file_path| "  Alias #{url_path} #{file_path}" }.join("\n") %>

<% end %>
<% if @params[:passenger_default_user] %>
  PassengerDefaultUser <%= @params[:passenger_default_user] %>
<% end %>
<% if @node[:apache][:ssl] && listen[:ssl] %>

  SSLEngine on
  SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
  SSLCertificateFile <%= @params[:ssl_cert_file] %>
  SSLCertificateKeyFile <%= @params[:ssl_key_file] %>
  SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
  <Files ~ "\.(cgi|shtml|phtml|php3?)$">
    SSLOptions +StdEnvVars
  </Files>
<% end%>
</VirtualHost>

<% end %>
<% unless @params[:directories].nil? || @params[:directories].empty? %>
<% @params[:directories].each do |dir,dirparams| %>
<Directory <%= dir %>>
<% unless dirparams[:options].nil? || dirparams[:options].empty? %>
  Options <%= dirparams[:options].join(' ') %>
<% end %>
  AllowOverride <%= dirparams[:allow_override] || 'None' %>
  Order allow,deny
  Allow from all
</Directory>

<% end %>
<% end %>